1.Introduction											[15-OCT-2019]  (Done)
2.Five Spring Security Concepts							[15-OCT-2019]  (Done)
3.Adding Spring Security To Spring Boot Project			[17-OCT-2019]  (Done)
4.Spring Security Authentication						[17-OCT-2019]  (Done)
5.Spring Security Authorization							[17-OCT-2019]  (Done)
6.Internally Authentication Works   					[]
7.Spring Security JDBC Authentication  					[21-OCT-2019]  (Done)
8.Spring Security JPA Authentication    				[]
9.JSON Web Token 										[]																																							 													


********************************************************* 1.Introduction :  ****************************************************************************

Whenever we want to secure a Web Application we have to put lot of efforts to implement with multiple layers of Security.
We even anticipate that some of them might get hacked.
Here Spring Security comes into picture.
Application Security is not fun and Security is often an after thought.
Security potentially causes User Frustration.
Here Web Server has built in Security and why should I deal with Security as an Application Developer.
All the OS Level Security,JVM Level Security and Server Level Security is already taken Care.

Here we are talking about Application Level Security.
In the Context of Application Level Security,what are the functionalities we want to allow,To whom we want to allow and To whom we want to expose data.
The biggest thing that the Security makes the challenge is Security threats are constantly evolving and morphing.
Spring Security is like Security Guard that examines an Application for each and every request and every time it asks who are you and what do you want.
Spring Security is a Framework that provides Application Level Security.

Spring Security Provides :
Login and Logout Functionality
We can allow/block the user to have an access for the specific path
We can allow/block the user to have an access for the specific path but with Certain Roles

The above things can be done by using Configuration.
Spring Security allows us to Configure based on application needs.
Spring Security has been built in a very flexible and customizable way.
Spring Security can handle common Security vulnerabilities out of box Like 

Session Fixation,ClickJacking,Click Site Request Forgery etc.

Spring Security is widely adapted and people are constantly trying to find Vulnerabilities in it.
However even if the vulnerability is found it is immediately patched.
We cannot achieve Security based on secrecy or hiding the vulnerabilities.
We get the effective security by removing the vulnerabilities.

By Using Spring Security we can implement :

UserName and Password Authentication
Single Sign on Stuff Like SSO/OKTA/LDAP
Application Level Authorization
Intra Application Authorization Like OAuth
Micro Service Security Using Tokens,JWT
Method Level Security

********************************************************* 2.Five Spring Security Concepts : *********************************************************

1.Authentication
2.Authorization
3.Principal
4.Granted Authority
5.Roles

1.Authentication :
------------------
Spring Security is like Security Guard in front of Web Application that authenticates each and every request.
Who are you is called Authentication and what do you want.
Most Web Application Like Face Book,Linked In etc have some representation of Id .
These Sites will have Id's in their System that uniquely corresponding to us.
After identifying the Id ,should prove that it is yourself. 
Common way it is done by using Password.
This Kind of Authentication is called Knowledge Based Authentication.
Here Authentication is done based on knowledge we have like Password,Pin Code or answer to a particular Question.
Here the Advantage is It is simple and it is easy to use.
The disadvantage is it is not fully Safe if some one steals the password.

There are some other Authentication like possession based Authentication 
Phone Calls/Text Messages
Key Cards and Badges
Access Token Device
Some Applications uses both Knowledge based and possession based Authentication and are called as Multi Factor Authentication.

Authorization :
---------------
It is nothing but what the User can do and what he is supposed to do.
It is like Yes or No.
Once the user is successfully Authenticated,What the user can do depends on who the user is called Authorization.
Authentication and Authorization are widely used in the Software Development.

Principal :
-----------
Authentication is the process of identifying the person who is trying to access the Application where as 
Principal is the person who has identified through the process of Authentication.
Principal is the currently Logged In User.
Once we have Authenticated to any Application by giving UserName and Password then Application establishes the Principal and remembers It.
This is the only reason we Authenticate with the Application only once and no need to enter the Id and Password for every request on page load.
There may not be any One To One Mapping between User,Human Being and Principal.
Example: A Single Peron can create Multiple Google Accounts.
If the User switches from One Account to Another Account,The Principal will be the currently Logged in User.

Granted Authority :
-------------------
How does the Application decide whether it needs to allow or decline for a particular access(API).
In this Case Application Owner or Maintainer should have handled before the Access.
If the User is X and he has access to only some actions in the Application.This Concept of Permission is called Authorization.
Granted Authority is a fine Grained permissions that a user can do.

Roles :
-------
Role is nothing but Group of Authorities that are usually assigned together.
Roles are more fine Grained Permissions than Granted Authority.

********************************************************* 3.Adding Spring Security To Spring Boot Project :  *********************************************

By adding Spring Security dependency to the Classpath,Spring Security will start working and it stops accessing the Application.
Spring Security internally uses filters for each and every request.
Whenever user makes a request to an Application,there will be a particular Servlet that does the functionality and provides the response for that particular request.
The way the particular servlet handles the request is by mapping to the URL.
The right Servlet will be executed based on the URL Mapping.
Filters are Like Cross Cutting Concerns that intercepts each and every Request.
Like Log every request,Checks every request has particular Header or Not.
While Servlets are mapped to URL's similarly Filters can be applied to All URL's.

Spring Security by default does some of the things :
1.It adds mandatory Authentication for all the URL's.
2.It adds The Login Form
3.It handles Login Error
4.Spring Boot by default comes with an Error Page

Whenever we add the Spring Security in the classpath by default it creates a default user Called user and password in the console by default.
We can also customize the default user and password by declaring it in the Properties File.

********************************************************* 4.Spring Security Authentication :  *********************************************************

Here we will be creating In Memory Authentication for the Spring Boot Application.
Spring Security Authentication should be done based on bunch of Users we have.In real time we get the Users from Database or LDAP etc.
Here we create bunch of Users as hardcoded and save them in Memory.

The way to configure Authentication in Spring Security is by using Authentication Manager.
Authentication Manager manages the Authentication in the Spring Security Application.
It has the Method called configure() and it returns successful Authentication or throws and Exception.
The way to effect Authentication Manger is not by creating our own Authentication Manager and is to configure what Authentication Manager does by using Builder Pattern.
We don't work with AuthenticationManager directly most of the times and we use Builder Class called AuthenticationManagerBuilder.
We use AuthenticationManagerBuilder to configure what the Authentication Manager is supposed to do.

Steps to Configure Authentication is 
1.Get hold of AuthenticationManagerBuilder
2.Set the Configuration on AuthenticationManagerBuilder

Here we need to create a Configuration Class and that extends WebSecurityConfigurerAdapter and override the default Method ie configure(AuthenticationManagerBuilder builder).
If we don't override then it will do the default Authentication.

		@EnableWebSecurity
		public class SecurityConfiguration extends WebSecurityConfigurerAdapter
		{
			@Override
			protected void configure(AuthenticationManagerBuilder auth) throws Exception 
			{
				auth.inMemoryAuthentication()
				.withUser("Bhaumik")
				.password("Bhaumik")
				.roles("USER");
			}
			@Bean
			public PasswordEncoder getPasswordEncoder()
			{
				return NoOpPasswordEncoder.getInstance();
			}
		}

After Configuration of AuthenticationManagerBuilder with the necessary details It will create a new AuthenticationManager which has the values we mentioned in the Configuration.
AuthenticationManagerBuilder follows the Method Chaining pattern to configure the Authentication.
Add the Annotation @EnableWebSecurity to the SecurityConfiguration.
Whenever we are dealing with Passwords we don't want to work with Clear Text.
Clear Text is Saving the password as String.
Always deal with hashed Passwords.Spring Security enforces the Password Encoding.
Here we need to create a bean with PasswordEncoder.NoOpPasswordEncoder is considered as a String by default.
If we want to configure bunch Of Users we use and().

********************************************************* 4.Spring Security Authorization :  *********************************************************

Starting point to perform Spring Security Authorization is a basic Spring Boot Application with Spring Security added and it has In Memory Authentication.
Here Authentication can be In Memory or Database or OAuth Users and so on.
All we need is a couple of users with certain roles so that we can configure certain API to be accessed by one role and so on.
Here we are using In Memory Authentication for learning purpose.
Default behavior of Spring Security is it immediately adds the Authentication to all The API's and Authorizes all the API's.
Here default behavior is API needs Authentication and we want different API's has different access requirements or different level of Access Controls.
Here the requirement is :

/ has to be accessed by all The Users
/user has to accessed by all the Role USER and ADMIN
/admin  has to accessed By all The Role ADMIN

If we want to configure these kind of Authorization we use an Object of HttpSecurity.
Here we need to create a Configuration Class and that should extends WebSecurityConfigurerAdapter and override the default Method.

	@Override
	protected void configure(HttpSecurity http) throws Exception 
	{
		http.authorizeRequests()
		.antMatchers("/user").hasRole("SON")
		.antMatchers("/admin").hasAnyRole("SON","WIFE")
		.antMatchers("/").permitAll()
		.and().formLogin();
	}

Here use Builder Methods to configure the Authorizations.
We use AntMatchers for the Paths.
Spring Security has LogOut page by using logout.
To allow any kind of Users we use permitAll.

********************************************************* 7.Spring Security JDBC Authentication  :  *****************************************************

Here we are using In Memory Database ie H2 for Authentication.
Here we can also use JDBC API that interacts with Database and validates the Authentication Process.
To look up the User details into the Database we need to configure the DataSource.
We need to Autowired the Datasource and pass the DataSource to the JDBC Authentication i.e 

		@Autowired
		DataSource dataSource;
		
		authenticationManagerBuilder.jdbcAuthentication()
		.dataSource(dataSource);
		
With this line we have configured Spring Security to Point to the H2 Database.
When we add an Embedded Database to Spring Boot Application,Spring Boot internally creates a Data source for us.
Next Step is to create the schema in the H2 Database.
Create the users that are populated in the Schema.
Spring Security has some default opinions specifically about the User and Authorities Tables.
If we provide the clean Database to Spring Security to work with,Spring Security Creates the User and Authorities Tables For Us.

		authenticationManagerBuilder.jdbcAuthentication()
		.dataSource(dataSource)
		.withDefaultSchema();

Now H2 Database is Configured with Default Tables Like User and Authorities.	
We also need to add the Password Encoder to avoid the failure issue.
We need to set up some files that populates couple of Schema's and Tables.	
And at the time of Authentication we would assume that Schema and Tables are available and we would be Authenticating using Database.

https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#user-schema

Create the Schema.sql in the resources folder that will create the DDL Statements for the H2 Database.
Create the data.sql to populate the data in the Database.

authenticationManagerBuilder.jdbcAuthentication()
		.dataSource(dataSource)
		.withDefaultSchema()
		.withUser(User.withUsername("user")
				.password("pass")
				.roles("USER"))
		.withUser(User.withUsername("admin")
				.password("pass")
				.roles("ADMIN")
		);

Here we are working with default schema.
If there are different Schema we need to add these Methods to the Data source.

		 authenticationManagerBuilder.jdbcAuthentication()
		.dataSource(dataSource)
		.usersByUsernameQuery("")
		.authoritiesByUsernameQuery("");
		
These are the default return types that Spring Security expects and we can also override the above Queries.
If we want to connect to the external Database Then add the dependency in pom.xml and remove H2 dependency.

********************************************************* 8.Spring Security JPA Authentication   : *********************************************************

Add @EnableJpaRepositories to the Spring Boot Application.


*********************************************************        END             ***************************************************************************









 